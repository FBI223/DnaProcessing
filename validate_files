ğŸ§  1. ğŸ“„ SprawdÅº nagÅ‚Ã³wek i @RG (Read Group)
bash
KopiujEdytuj
samtools view -H aln.fixed.bam
Szukaj:
    â€¢ @HD, @SQ, @RG, @PG
    â€¢ @RG musi zawieraÄ‡: ID, SM, PL co najmniej

ğŸ§¬ 2. ğŸ“Œ SprawdÅº poprawnoÅ›Ä‡ RG:Z: w rekordach
bash
KopiujEdytuj
samtools view aln.fixed.bam | head -10
Na koÅ„cu rekordu powinno byÄ‡:
ruby
KopiujEdytuj
RG:Z:E250094780_L1

ğŸ“Š 3. ğŸ§¾ Podstawowe statystyki
bash
KopiujEdytuj
samtools flagstat aln.fixed.bam
Wynik:
    â€¢ mapped: >95%
    â€¢ properly paired: wysoki %
    â€¢ duplicates: OK jeÅ›li nie usuniÄ™to jeszcze

ğŸ§® 4. ğŸ¯ RozkÅ‚ad MAPQ (jakoÅ›Ä‡ dopasowania)
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '{print $5}' | sort | uniq -c
Szukaj dominacji:
    â€¢ 60 (unikalne dopasowania)
    â€¢ maÅ‚o 0 (niedopasowane)

ğŸ§¬ 5. ğŸ”¤ RozkÅ‚ad CIGAR (typ dopasowania)
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '{print $6}' | sort | uniq -c | sort -nr | head
Szukaj:
    â€¢ CIGAR 150M, 76M, itp.
    â€¢ maÅ‚o * (niezmapowane)

ğŸ§ª 6. ğŸ§© RozkÅ‚ad flag SAM (paired-end)
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '{print $2}' | sort | uniq -c | sort -nr
Szukaj poprawnych flag:
    â€¢ 99, 147, 83, 163 (paired, mapped, proper)
    â€¢ maÅ‚o 77, 141 (unmapped)

ğŸ“ 7. ğŸ”¬ GÅ‚Ä™bokoÅ›Ä‡ pokrycia (coverage)
Per-chromosome:
bash
KopiujEdytuj
samtools idxstats aln.fixed.bam
Globalne (Å›rednie coverage):
bash
KopiujEdytuj
samtools depth -a aln.fixed.bam | awk '{sum+=$3} END { print "Average coverage = ",sum/NR}'

ğŸ§¼ 8. ğŸ” Zliczenie duplikatÃ³w (bez usuwania)
bash
KopiujEdytuj
gatk MarkDuplicates \
  -I aln.fixed.bam \
  -O /dev/null \
  -M aln.dup.metrics.txt \
  --REMOVE_DUPLICATES false
Zobacz zawartoÅ›Ä‡:
bash
KopiujEdytuj
cat aln.dup.metrics.txt

ğŸ“‹ 9. ğŸ§® Histogram dÅ‚ugoÅ›ci insertu (ISIZE)
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '($9 > 0) { print $9 }' | sort -n | uniq -c | sort -nr | head

âœ… 10. ğŸ›‚ Walidacja BAM przez Picard stricte (dodatkowo)
bash
KopiujEdytuj
picard ValidateSamFile \
  I=aln.fixed.bam \
  R=GRCh38p14.fa \
  MODE=SUMMARY

ğŸ” 11. ğŸ§ª Opcjonalnie: wykrycie nieprawidÅ‚owych rekordÃ³w
bash
KopiujEdytuj
samtools view -h aln.fixed.bam | grep -v '^@' | awk '{ if ($1 == "" || $3 == "*") print $0 }' | wc -l

ğŸ“Œ 12. ğŸ”¬ IloÅ›Ä‡ readÃ³w z MAPQ=0
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '{if ($5 == 0) c++} END {print c " unmapped or low-quality reads"}'

ğŸ§® 13. ğŸ¯ Histogram liczby readÃ³w per chromosom
bash
KopiujEdytuj
samtools idxstats aln.fixed.bam | cut -f 1,3

ğŸ” 14. ğŸ”„ Zliczenie par i singletonÃ³w
bash
KopiujEdytuj
samtools view -f 1 -F 12 aln.fixed.bam | wc -l     # paired mapped
samtools view -f 4 aln.fixed.bam | wc -l          # unmapped
samtools view -f 8 aln.fixed.bam | wc -l          # mate unmapped

ğŸ§  15. ğŸ“Š DokÅ‚adna analiza znacznikÃ³w NM, MD, AS (opcjonalne)
bash
KopiujEdytuj
samtools view aln.fixed.bam | awk '{for(i=12;i<=NF;i++) if($i ~ /^NM:i:/) print $i}' | sort | uniq -c

ğŸ§ª 16. ğŸ“‚ Czy plik BAM jest posortowany po koordynatach?
bash
KopiujEdytuj
samtools view -H aln.fixed.bam | grep '@HD'
Oczekiwane:
css
KopiujEdytuj
@HD      VN:1.6  SO:coordinate

âœ… Po tych 16 testach masz 100% pewnoÅ›ci, Å¼e BAM:
    â€¢ ma poprawny nagÅ‚Ã³wek, tagi, strukturÄ™
    â€¢ zostaÅ‚ poprawnie zmapowany
    â€¢ jest gotowy do downstream (MarkDuplicates, BaseRecalibrator, HaplotypeCaller)

Chcesz, Å¼ebym z tego wygenerowaÅ‚ gotowy skrypt validate_bam_full.sh z zapisaniem statystyk do pliku .txt?
PowiedziaÅ‚eÅ›(-aÅ›):
teraz chce pousuwac duplikaty oraz przygotowac pod variant calling przefilrtowac zle rzeczy itd 
ChatGPT powiedziaÅ‚:
âœ… PeÅ‚ny pipeline oczyszczenia BAM pod GATK Variant Calling (WGS/WES)
ZakÅ‚adamy, Å¼e masz:
    â€¢ âœ” aln.fixed.bam
    â€¢ âœ” GRCh38p14.fa oraz .fai, .dict
    â€¢ âœ” GATK 4.6+, samtools, picard

ğŸ§¹ 1. UsuÅ„ duplikaty PCR (MarkDuplicates)
bash
KopiujEdytuj
gatk MarkDuplicates \
  -I aln.fixed.bam \
  -O aln.dedup.bam \
  -M aln.dedup.metrics.txt \
  --REMOVE_DUPLICATES true
â¡ï¸ SprawdÅº metryki:
bash
KopiujEdytuj
less aln.dedup.metrics.txt

ğŸ“ 2. Dodaj index .bai
bash
KopiujEdytuj
samtools index aln.dedup.bam

ğŸ§ª 3. (opcjonalnie) Base Quality Score Recalibration (BQSR)
JeÅ›li masz plik .vcf znanych wariantÃ³w (np. dbSNP):
(a) Baza do BQSR (recal table)
bash
KopiujEdytuj
gatk BaseRecalibrator \
  -R GRCh38p14.fa \
  -I aln.dedup.bam \
  --known-sites dbsnp_renamed.vcf.gz \
  -O recal.table
(b) Zastosuj BQSR
bash
KopiujEdytuj
gatk ApplyBQSR \
  -R GRCh38p14.fa \
  -I aln.dedup.bam \
  --bqsr-recal-file recal.table \
  -O aln.recal.bam
(jeÅ›li brak known-sites, pomiÅ„ ten krok i pracuj na aln.dedup.bam)

ğŸ” 4. (opcjonalnie) Filtracja zbyt krÃ³tkich, unmapped, niskiej jakoÅ›ci readÃ³w
bash
KopiujEdytuj
samtools view -@ 8 -b \
  -F 4 \                      # mapped only
  -F 256 \                   # primary alignments only
  -q 20 \                    # MAPQ â‰¥ 20
  aln.recal.bam > aln.filtered.bam

samtools index aln.filtered.bam

ğŸ§ª 5. SprawdÅº koÅ„cowy plik BAM
bash
KopiujEdytuj
gatk ValidateSamFile -I aln.filtered.bam -R GRCh38p14.fa
samtools flagstat aln.filtered.bam

ğŸ§¬ 6. Variant Calling (GVCF)
bash
KopiujEdytuj
gatk HaplotypeCaller \
  -R GRCh38p14.fa \
  -I aln.filtered.bam \
  -O sample.g.vcf.gz \
  -ERC GVCF

ğŸ“‹ 7. (opcjonalnie) Summary BAM stats (bamtools)
bash
KopiujEdytuj
bamtools stats -in aln.filtered.bam
